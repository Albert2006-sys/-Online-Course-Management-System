<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div>
      <h1>
        <mat-icon>dashboard</mat-icon>
        Dashboard
      </h1>
      <p class="subtitle">Welcome to the Online Course Management System</p>
    </div>
    <button mat-raised-button color="primary" (click)="refreshDashboard()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  <!-- Quick Navigation Hub -->
  <mat-card class="nav-hub-card">
    <mat-card-title>
      <mat-icon>apps</mat-icon>
      <span>Quick Navigation</span>
    </mat-card-title>
    <mat-card-content>
      <div class="nav-hub-grid">
        <button mat-stroked-button color="primary" routerLink="/courses">
          <mat-icon>school</mat-icon>
          <span>Manage Courses</span>
        </button>
        <button mat-stroked-button color="primary" routerLink="/students">
          <mat-icon>people</mat-icon>
          <span>Manage Students</span>
        </button>
        <button mat-stroked-button color="primary" routerLink="/enrollments">
          <mat-icon>assignment</mat-icon>
          <span>View Enrollments</span>
        </button>
        <button mat-stroked-button color="primary" routerLink="/feedback">
          <mat-icon>feedback</mat-icon>
          <span>View Feedback</span>
        </button>

        <button mat-raised-button color="accent" routerLink="/courses/new">
          <mat-icon>add</mat-icon>
          <span>New Course</span>
        </button>
        <button mat-raised-button color="accent" routerLink="/students/new">
          <mat-icon>person_add</mat-icon>
          <span>New Student</span>
        </button>
        <button mat-raised-button color="accent" routerLink="/enrollments/new">
          <mat-icon>playlist_add</mat-icon>
          <span>New Enrollment</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading dashboard data...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading && dashboardStats" class="dashboard-content">
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <!-- Total Courses -->
      <mat-card class="stat-card courses-card clickable" (click)="openDetail('courses', 'All Courses')" matTooltip="View Course List">
        <div class="stat-icon-container">
          <mat-icon>school</mat-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Courses</p>
          <h2 class="stat-value">{{ dashboardStats.totalCourses }}</h2>
        </div>
        <div class="stat-footer">
          <span class="trend" [ngClass]="statTrends.courses.direction">
            <mat-icon>{{ getTrendIcon(statTrends.courses.direction) }}</mat-icon>
            {{ statTrends.courses.text }}
          </span>
          <span class="footer-label">{{ statTrends.courses.label }}</span>
        </div>
      </mat-card>

      <!-- Total Students -->
      <mat-card class="stat-card students-card clickable" (click)="openDetail('students', 'Registered Students')" matTooltip="View Student List">
         <div class="stat-icon-container">
          <mat-icon>people</mat-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Students</p>
          <h2 class="stat-value">{{ dashboardStats.totalStudents }}</h2>
        </div>
        <div class="stat-footer">
          <span class="trend" [ngClass]="statTrends.students.direction">
            <mat-icon>{{ getTrendIcon(statTrends.students.direction) }}</mat-icon>
            {{ statTrends.students.text }}
          </span>
          <span class="footer-label">{{ statTrends.students.label }}</span>
        </div>
      </mat-card>

      <!-- Total Enrollments -->
      <mat-card class="stat-card enrollments-card clickable" (click)="openDetail('enrollments', 'Enrollment History')" matTooltip="View Enrollments">
         <div class="stat-icon-container">
          <mat-icon>assignment</mat-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Enrollments</p>
          <h2 class="stat-value">{{ dashboardStats.totalEnrollments }}</h2>
        </div>
        <div class="stat-footer">
          <span class="trend" [ngClass]="statTrends.enrollments.direction">
            <mat-icon>{{ getTrendIcon(statTrends.enrollments.direction) }}</mat-icon>
            {{ statTrends.enrollments.text }}
          </span>
          <span class="footer-label">{{ statTrends.enrollments.label }}</span>
        </div>
      </mat-card>

      <!-- Total Revenue -->
      <mat-card class="stat-card revenue-card clickable" (click)="openDetail('revenue', 'Revenue Analysis')" matTooltip="View Revenue Details">
         <div class="stat-icon-container">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Revenue</p>
          <h2 class="stat-value">{{ formatCurrency(dashboardStats.totalRevenue) }}</h2>
        </div>
         <div class="stat-footer">
          <span class="trend" [ngClass]="statTrends.revenue.direction">
            <mat-icon>{{ getTrendIcon(statTrends.revenue.direction) }}</mat-icon>
            {{ statTrends.revenue.text }}
          </span>
          <span class="footer-label">{{ statTrends.revenue.label }}</span>
        </div>
      </mat-card>
    </div>

    <!-- Insights Section -->
    <div class="insights-grid">
      <mat-card class="insight-card">
        <div class="insight-icon">
          <mat-icon>star</mat-icon>
        </div>
        <div class="insight-info">
          <div class="insight-label">Top Performer</div>
          <div class="insight-value">{{ mostPopularCourse }}</div>
        </div>
      </mat-card>

      <mat-card class="insight-card">
        <div class="insight-icon warning">
          <mat-icon>warning</mat-icon>
        </div>
        <div class="insight-info">
          <div class="insight-label">Needs Attention</div>
          <div class="insight-value">{{ leastPopularCourse }}</div>
        </div>
      </mat-card>

      <mat-card class="insight-card">
        <div class="insight-icon info">
          <mat-icon>category</mat-icon>
        </div>
        <div class="insight-info">
          <div class="insight-label">Top Category</div>
          <div class="insight-value">{{ topCategory }}</div>
        </div>
      </mat-card>
    </div>

    <!-- Engagement Snapshot & Alerts -->
    <div class="engagement-layout">
      <div class="snapshot-grid">
        <mat-card class="snapshot-card" *ngFor="let metric of engagementMetrics">
          <div class="snapshot-icon">
            <mat-icon>{{ metric.icon }}</mat-icon>
          </div>
          <div>
            <p class="snapshot-label">{{ metric.label }}</p>
            <h3 class="snapshot-value">{{ metric.value }}</h3>
            <span class="snapshot-helper">{{ metric.helper }}</span>
          </div>
        </mat-card>
      </div>

      <div class="engagement-side">
        <mat-card class="funnel-card" *ngIf="learningFunnel.length">
          <mat-card-header>
            <mat-card-title>Learning Funnel</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="funnel-step" *ngFor="let step of learningFunnel">
              <div class="step-header">
                <span>{{ step.label }}</span>
                <strong>{{ step.value }}</strong>
              </div>
              <mat-progress-bar mode="determinate" [value]="step.percent"></mat-progress-bar>
              <small>{{ step.percent }}% of total</small>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="alerts-card" *ngIf="courseAlerts.length; else noAlerts">
          <mat-card-header>
            <mat-card-title>Course Alerts</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="alert-item" *ngFor="let alert of courseAlerts">
              <mat-icon [ngClass]="alert.severity === 'warn' ? 'warn' : 'info'">
                {{ alert.severity === 'warn' ? 'warning' : 'lightbulb' }}
              </mat-icon>
              <div>
                <p class="alert-title">{{ alert.title }}</p>
                <p class="alert-detail">{{ alert.detail }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
        <ng-template #noAlerts>
          <mat-card class="alerts-card empty">
            <mat-card-content>
              <mat-icon>task_alt</mat-icon>
              <p>All courses look healthy</p>
            </mat-card-content>
          </mat-card>
        </ng-template>
      </div>
    </div>

    <!-- Main Charts Grid -->
    <div class="main-charts-grid">
      <!-- Enrollment Trends (Line Chart) -->
      <mat-card class="chart-card large-chart">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>show_chart</mat-icon> Enrollment Growth
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container large">
            <canvas #trendChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Revenue History (Bar Chart) -->
      <mat-card class="chart-card side-chart">
        <mat-card-header>
          <mat-card-title>
             <mat-icon>bar_chart</mat-icon> Revenue
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #revenueChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Secondary Charts Grid -->
    <div class="secondary-charts-grid">
      <!-- Top Performing Courses -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Top Courses</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #performanceChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Category Distribution -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Categories</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #categoryChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Completion Status -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Completion Rate</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #completionChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Detailed Lists Grid -->
    <div class="lists-grid">
      <!-- Recent Enrollments -->
      <mat-card class="list-card">
        <mat-card-header>
          <mat-card-title>Recent Activity</mat-card-title>
        </mat-card-header>
        <mat-card-content>
           <mat-list>
              <mat-list-item *ngFor="let enrollment of dashboardStats.recentEnrollments">
                 <mat-icon matListItemIcon>person_outline</mat-icon>
                 <div matListItemTitle class="list-title">{{ enrollment.studentName }}</div>
                 <div matListItemLine class="list-subtitle">Enrolled in {{ enrollment.courseName }}</div>
                 <div matListItemMeta class="list-meta">{{ formatDate(enrollment.enrollmentDate) }}</div>
              </mat-list-item>
           </mat-list>
        </mat-card-content>
      </mat-card>
      
       <!-- Popular Courses List (Text) -->
      <mat-card class="list-card">
        <mat-card-header>
          <mat-card-title>Course Rankings</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="ranking-list">
             <div *ngFor="let course of dashboardStats.popularCourses; let i = index" class="ranking-item">
               <div class="ranking-badge">{{ i + 1 }}</div>
               <div class="ranking-info">
                 <div class="ranking-title">{{ course.title }}</div>
                 <mat-progress-bar mode="determinate" [value]="getPopularityPercentage(course.enrollmentCount)"></mat-progress-bar>
               </div>
               <div class="ranking-count">{{ course.enrollmentCount }}</div>
             </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
